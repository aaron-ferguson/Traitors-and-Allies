<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Among Us - In-Person Game Manager</title>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Among Us IRL</h1>
            <p class="subtitle">Minigames and betrayal in your own backyard!</p>
        </header>

        <!-- MAIN MENU -->
        <div id="main-menu">
            <div class="card" style="text-align: center; max-width: 500px; margin: 0 auto;">
                <button class="btn-primary btn-block" onclick="showCreateGame()" style="margin-bottom: 15px; font-size: 1.2rem; padding: 20px;">
                    Create New Game
                </button>

                <button class="btn-secondary btn-block" onclick="showJoinGame()" style="margin-bottom: 15px; font-size: 1.2rem; padding: 20px;">
                    Join Existing Game
                </button>

                <button class="btn-secondary btn-block" onclick="showInstructions()" style="font-size: 1.2rem; padding: 20px;">
                    Game Instructions
                </button>

                <!-- Join Game Input (hidden by default) -->
                <div id="join-game-section" class="hidden" style="margin-top: 30px; padding-top: 30px; border-top: 2px solid rgba(255,255,255,0.1);">
                    <h3>Enter Room Code</h3>
                    <input type="text" id="menu-room-code-input" placeholder="ABCD"
                           style="width: 100%; padding: 15px; font-size: 1.2rem; text-align: center; text-transform: uppercase; letter-spacing: 5px; margin-bottom: 15px;"
                           maxlength="4">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-success" onclick="joinGameFromMenu()" style="flex: 1;">Join Game</button>
                        <button class="btn-secondary" onclick="hideJoinGame()" style="flex: 1;">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- STAGE 1: GAME SETUP -->
        <div id="setup-phase">
            <div class="card">
                <h2>Game Setup</h2>

                <!-- General Setup -->
                <h3>General Settings</h3>
                <div class="input-row">
                    <div class="input-group">
                        <label for="min-players">Minimum Players (recommended ‚â•4):</label>
                        <input type="number" id="min-players" min="3" max="15" value="4">
                    </div>
                    <div class="input-group">
                        <label for="max-players">Maximum Players (recommended ‚â§15):</label>
                        <input type="number" id="max-players" min="3" max="15" value="10">
                    </div>
                </div>

                <div class="input-group">
                    <label for="tasks-per-player">Tasks per Player:</label>
                    <input type="number" id="tasks-per-player" min="1" max="10" value="4">
                </div>

                <!-- Room & Task Selection -->
                <h3>Rooms & Tasks</h3>
                <div class="collapsible" onclick="toggleCollapsible(this)">
                    <span>Select Rooms and Tasks in Play</span>
                    <span>‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="edit-mode-toggle">
                        <button class="btn-secondary edit-mode-btn" onclick="toggleEditMode()" id="edit-mode-btn">
                            ‚úèÔ∏è Edit Mode
                        </button>
                    </div>
                    <div id="rooms-tasks-container"></div>
                </div>

                <!-- Unique Tasks Configuration -->
                <h3>Unique Tasks</h3>
                <div class="input-group">
                    <label>
                        <input type="radio" name="unique-mode" value="none" checked> No unique tasks
                    </label>
                    <label>
                        <input type="radio" name="unique-mode" value="random"> Randomly assign
                        <input type="number" id="unique-count" min="1" max="3" value="2" style="width: 60px; display: inline-block; padding: 5px;"> unique task(s)
                    </label>
                    <label>
                        <input type="radio" name="unique-mode" value="manual"> Manually select unique tasks (flag them above)
                    </label>
                </div>

                <!-- Imposter Setup -->
                <h3>Imposter Settings</h3>
                <div class="input-group">
                    <label for="imposter-count">Number of Imposters:</label>
                    <input type="number" id="imposter-count" min="1" max="3" value="1">
                    <small style="color: #a0a0a0; display: block; margin-top: 5px;">
                        Recommended: 4-5 players = 1, 6-8 players = 2, 9-15 players = 3
                    </small>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label for="elimination-cooldown">Elimination Cooldown (seconds):</label>
                        <input type="number" id="elimination-cooldown" min="10" max="120" value="30">
                    </div>
                    <div class="input-group">
                        <label for="cooldown-reduction">Cooldown Reduction After Meeting (seconds):</label>
                        <input type="number" id="cooldown-reduction" min="0" max="30" value="5">
                    </div>
                </div>

                <!-- Meeting Setup -->
                <h3>Meeting Settings</h3>
                <div class="input-group">
                    <label for="meeting-room">Meeting Location:</label>
                    <select id="meeting-room">
                        <option value="">Select a room...</option>
                    </select>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label for="meeting-limit">Emergency Meetings Allowed:</label>
                        <input type="number" id="meeting-limit" min="0" max="10" value="1">
                        <small style="color: #a0a0a0; display: block; margin-top: 5px;">Default: 1 per player</small>
                    </div>
                    <div class="input-group">
                        <label for="meeting-timer">Meeting Timer (seconds):</label>
                        <input type="number" id="meeting-timer" min="30" max="300" value="60">
                    </div>
                </div>

                <!-- Additional Rules -->
                <h3>Additional Rules</h3>
                <div class="input-group">
                    <label for="additional-rules">Additional Instructions (out-of-bounds areas, special rules, etc.):</label>
                    <textarea id="additional-rules" placeholder="Example: The basement and second floor are out of bounds. Stay on the main floor only."></textarea>
                </div>

                <button class="btn-primary btn-block" onclick="(async () => await createGame())()">Create Game & Enter Waiting Room</button>
            </div>
        </div>

        <!-- STAGE 2: WAITING ROOM -->
        <div id="waiting-room" class="hidden">
            <div class="card">
                <h2>Waiting Room</h2>

                <!-- Room Code & QR -->
                <div style="background: rgba(94, 179, 246, 0.2); border: 3px solid rgba(94, 179, 246, 0.5); border-radius: 15px; padding: 25px; margin-bottom: 25px; text-align: center;">
                    <p style="color: #a0a0a0; margin-bottom: 10px;">Share this code or scan the QR:</p>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                        <div id="room-code" style="font-size: 3rem; font-weight: 700; letter-spacing: 8px; color: #5eb3f6;">ABCD</div>
                        <button onclick="copyGameURL()" class="btn-primary" style="padding: 15px 25px;">
                            üìã Copy URL
                        </button>
                    </div>
                    <div class="qr-placeholder" style="width: 200px; height: 200px; margin: 10px auto; background: white; border-radius: 10px; padding: 10px; display: flex; align-items: center; justify-content: center;">
                        <img id="qr-code-image" src="" alt="QR Code" style="width: 100%; height: 100%;">
                    </div>
                    <p id="copy-feedback" style="color: #4caf50; margin-top: 10px; font-weight: 600; opacity: 0; transition: opacity 0.3s;">URL copied to clipboard!</p>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-primary" onclick="showInstructions()" style="flex: 1;">
                        üìñ Game Instructions
                    </button>
                    <button class="btn-warning" onclick="editSettings()" style="flex: 1;" id="edit-settings-btn">
                        ‚öôÔ∏è Edit Settings
                    </button>
                </div>

                <!-- Game Stats -->
                <div class="game-stats">
                    <div class="stat-box">
                        <div class="stat-number"><span id="ready-count">0</span>/<span id="min-players-display">4</span></div>
                        <div class="stat-label">Ready / Minimum</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number"><span id="joined-count">0</span>/<span id="max-players-display">10</span></div>
                        <div class="stat-label">Joined / Maximum</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="imposter-count-display">1</div>
                        <div class="stat-label">Imposters</div>
                    </div>
                </div>

                <!-- Join Section -->
                <div class="card" style="background: rgba(255, 255, 255, 0.05);">
                    <h3>Join the Game</h3>

                    <!-- Form to join game (shown when not joined) -->
                    <div id="join-form">
                        <p style="color: #a0a0a0; margin-bottom: 15px;">Enter your name to join the lobby</p>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="player-name-input" placeholder="Your name" style="flex: 1;">
                            <button class="btn-primary" onclick="joinGame()">Join</button>
                        </div>
                        <p id="room-full-message" class="hidden" style="color: #ff3838; margin-top: 10px; font-weight: 600;">
                            Room is full! Maximum players reached.
                        </p>
                    </div>

                    <!-- Already joined view (shown after joining) -->
                    <div id="already-joined" class="hidden">
                        <p style="color: #4caf50; margin-bottom: 15px;">‚úì You have joined as <strong id="my-player-name"></strong></p>
                        <button class="btn-primary" onclick="editMyName()" style="width: 100%;">‚úèÔ∏è Edit My Name</button>
                        <button class="btn-warning" onclick="leaveGame()" style="width: 100%; margin-top: 10px;">Leave Game</button>
                    </div>
                </div>

                <!-- Players List -->
                <div class="card" style="background: rgba(255, 255, 255, 0.05);">
                    <h3>Players Ready (<span id="ready-list-count">0</span>)</h3>
                    <div id="lobby-players"></div>
                </div>

                <!-- Host Controls -->
                <button class="btn-success btn-block" onclick="startGame()" id="start-game-btn" disabled>
                    Start Game (Waiting for minimum players to be ready)
                </button>
            </div>
        </div>

        <!-- STAGE 3: GAMEPLAY -->
        <div id="game-phase" class="hidden">
            <!-- Role Display -->
            <div class="card">
                <h2>Your Role</h2>
                <div class="role-display">
                    <div id="role-hidden" class="role-hidden">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                    <div id="role-revealed" class="hidden">
                        <span id="role-text"></span>
                    </div>
                    <button class="btn-primary" onclick="toggleRole()" style="margin-top: 15px;" id="toggle-role-btn">
                        Reveal Role
                    </button>
                </div>
            </div>

            <!-- Task List -->
            <div class="card" id="task-list-card">
                <h2>Your Tasks (<span id="completed-tasks-count">0</span>/<span id="total-tasks-count">0</span>)</h2>
                <div id="player-tasks"></div>
            </div>

            <!-- Emergency Meeting Button -->
            <div class="card">
                <button id="call-meeting-btn" class="btn-danger btn-block" onclick="callMeeting()" style="font-size: 1.5rem; padding: 20px;">
                    CALL MEETING
                </button>
                <p style="text-align: center; color: #a0a0a0; margin-top: 10px;">
                    Emergency meetings remaining: <span id="meetings-remaining">1</span>
                </p>
            </div>
        </div>

        <!-- STAGE 4: MEETING -->
        <div id="meeting-phase" class="hidden">
            <!-- Toggle button for Host Elimination Controls -->
            <button class="btn-warning btn-block hidden" id="toggle-elimination-controls-btn" onclick="toggleEliminationControls()" style="margin-bottom: 15px;">
                ‚ö†Ô∏è Mark Additional Eliminations
            </button>

            <!-- Host Elimination Controls -->
            <div class="card hidden" id="host-elimination-controls">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">Mark Additional Eliminations</h2>
                    <button class="btn-secondary btn-small" onclick="toggleEliminationControls()">Close</button>
                </div>
                <p style="color: #a0a0a0; margin-bottom: 15px;">Update player status before voting:</p>
                <div id="host-player-status-list"></div>
            </div>

            <!-- Report Body Selection -->
            <div class="card hidden" id="report-selection">
                <h2>Report Body</h2>
                <p style="color: #a0a0a0; margin-bottom: 15px;">Select eliminated player(s):</p>
                <div id="eliminated-players-list"></div>
                <button class="btn-primary btn-block" onclick="confirmReport()">Confirm Report</button>
            </div>

            <!-- Discussion Phase -->
            <div class="card hidden" id="discussion-phase">
                <h2>Discussion Phase</h2>
                <p style="text-align: center; color: #a0a0a0; margin-bottom: 20px;">
                    Discuss who you think the imposter is...
                </p>

                <!-- Ready status -->
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <p style="color: #a0a0a0; margin-bottom: 10px;">Players Ready: <span id="ready-for-vote-count">0</span>/<span id="total-players-count">0</span></p>
                    <div id="players-ready-list" style="font-size: 0.9rem; color: #5eb3f6;"></div>
                </div>

                <div style="text-align: center;">
                    <div class="timer-display" id="discussion-timer">60</div>
                    <button class="btn-success btn-block hidden" onclick="hostStartVoting()" id="host-start-voting-btn">
                        Start Discussion and Voting
                    </button>
                    <p id="waiting-for-players-msg" style="color: #a0a0a0; margin-top: 15px;">Waiting for all players to be ready...</p>
                </div>
            </div>

            <!-- Voting Phase -->
            <div class="card hidden" id="voting-phase">
                <h2>Vote to Eject</h2>

                <!-- Player status list -->
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <h3 style="font-size: 1rem; margin-bottom: 12px; color: #5eb3f6;">Player Status</h3>
                    <div id="vote-player-status-list" style="font-size: 0.9rem;"></div>
                </div>

                <p id="vote-timer-label" style="text-align: center; color: #a0a0a0; margin-bottom: 15px;">
                    Time remaining: <span id="vote-timer">60</span>s
                </p>

                <h3 id="vote-to-eliminate-label" style="font-size: 1.1rem; margin-bottom: 12px;">Vote to eliminate:</h3>
                <div id="vote-options"></div>

                <button class="btn-primary btn-block" onclick="submitVote()" id="submit-vote-btn" disabled>
                    Submit Vote
                </button>
            </div>

            <!-- Vote Results -->
            <div class="card hidden" id="vote-results">
                <h2>Vote Results</h2>
                <div id="results-display"></div>
                <div style="margin-top: 20px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; text-align: center;">
                    <h3 id="ejected-player-text"></h3>
                </div>
                <button class="btn-secondary btn-block hidden" onclick="resumeGame()" id="resume-game-btn" disabled>
                    Only Host Can Resume Game
                </button>
                <p id="waiting-for-host-resume" class="hidden" style="color: #a0a0a0; text-align: center; margin-top: 15px;">
                    Waiting for host to resume the game...
                </p>
            </div>
        </div>

        <!-- STAGE 5: GAME END -->
        <div id="game-end" class="hidden">
            <!-- Victory/Defeat Screen -->
            <div id="victory-screen" class="end-screen hidden">
                <h2>VICTORY</h2>
                <p style="font-size: 1.5rem; margin: 20px 0;">Your team won!</p>
                <p style="color: #a0a0a0;">Return to the meeting location: <span id="meeting-location-victory">Living Room</span></p>
            </div>

            <div id="defeat-screen" class="end-screen hidden">
                <h2>DEFEAT</h2>
                <p style="font-size: 1.5rem; margin: 20px 0;">Your team was defeated!</p>
                <p style="color: #a0a0a0;">Return to the meeting location: <span id="meeting-location-defeat">Living Room</span></p>
            </div>

            <!-- Game Summary -->
            <div class="card">
                <h2>Game Results</h2>
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3 id="winning-team" style="font-size: 2rem;"></h3>
                </div>

                <h3>All Players</h3>
                <div id="game-summary"></div>

                <!-- Host Controls (only visible to host) -->
                <div id="host-game-controls" class="hidden" style="margin-top: 30px;">
                    <button class="btn-primary btn-block" onclick="newGameSameSettings()">
                        New Game (Same Settings)
                    </button>
                    <button class="btn-secondary btn-block" onclick="newGameNewSettings()">
                        New Game (Change Settings)
                    </button>
                    <button class="btn-secondary btn-block" onclick="endSession()">
                        End Session
                    </button>
                </div>

                <!-- Join Next Game Button (shown when player declines immediate join) -->
                <div id="join-next-game-section" class="hidden" style="margin-top: 30px; text-align: center;">
                    <button class="btn-primary btn-block" onclick="acceptNewGameInvitation()">
                        Join Next Game
                    </button>
                </div>
            </div>
        </div>

        <!-- New Game Invitation Modal (outside game-end so it can show independently) -->
        <div id="new-game-invitation" class="modal hidden">
            <div class="modal-content" style="max-width: 400px;">
                <h2>New Game Starting</h2>
                <p style="color: #a0a0a0; margin: 20px 0;">The host is starting a new game. Would you like to join?</p>
                <button class="btn-primary btn-block" onclick="acceptNewGameInvitation()" style="margin-bottom: 10px;">
                    Join New Game
                </button>
                <button class="btn-secondary btn-block" onclick="declineNewGameInvitation('later')" style="margin-bottom: 10px;">
                    Not Yet
                </button>
                <button class="btn-secondary btn-block" onclick="declineNewGameInvitation('no')">
                    No Thanks
                </button>
            </div>
        </div>

        <!-- Name Confirmation Modal (outside game-end so it can show independently) -->
        <div id="name-confirmation-modal" class="modal hidden">
            <div class="modal-content" style="max-width: 400px;">
                <h2>Confirm Your Name</h2>
                <p style="color: #a0a0a0; margin: 20px 0;">Your previous name: <strong id="previous-name-display"></strong></p>
                <div id="name-edit-section" class="hidden" style="margin-bottom: 20px;">
                    <input type="text" id="name-edit-input" placeholder="Enter your name"
                           style="width: 100%; padding: 12px; font-size: 1rem; margin-bottom: 10px;">
                </div>
                <button class="btn-primary btn-block" onclick="confirmPlayerName()" id="confirm-name-btn" style="margin-bottom: 10px;">
                    Confirm Name
                </button>
                <button class="btn-secondary btn-block" onclick="editPlayerName()" id="edit-name-btn" style="margin-bottom: 10px;">
                    Edit Name
                </button>
                <button class="btn-secondary btn-block" onclick="leaveGame()">
                    Leave Game
                </button>
            </div>
        </div>

        <!-- Task Timer Modal -->
        <div id="task-timer-modal" class="modal hidden">
            <div class="modal-content">
                <div class="task-timer">
                    <h2 id="timer-task-name" class="timer-task-name"></h2>
                    <div class="timer-display" id="task-timer-display">30</div>
                    <p style="color: #a0a0a0;">Complete this task...</p>
                </div>
            </div>
        </div>

        <!-- Eliminated QR Modal -->
        <div id="eliminated-modal" class="modal hidden">
            <div class="modal-content">
                <div class="qr-display">
                    <h2 style="color: #ff3838; margin-bottom: 20px;">You Have Been Eliminated</h2>
                    <p style="color: #a0a0a0; margin-bottom: 20px;">
                        Show this QR code when your body is discovered
                    </p>
                    <div class="qr-placeholder" style="width: 200px; height: 200px; margin: 10px auto; background: white; border-radius: 10px; padding: 10px; display: flex; align-items: center; justify-content: center;">
                        <img id="eliminated-qr-code" src="" alt="Eliminated QR Code" style="width: 100%; height: 100%;">
                    </div>
                    <button class="btn-primary" onclick="closeEliminatedModal()" style="margin-top: 20px;">
                        Continue Doing Tasks
                    </button>
                </div>
            </div>
        </div>

        <!-- Instructions Modal -->
        <div id="instructions-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Game Instructions</h2>
                    <button class="modal-close" onclick="closeInstructions()">√ó</button>
                </div>

                <h3>How to Win</h3>
                <h4 style="color: #5eb3f6; margin-top: 15px;">Crewmates Win If:</h4>
                <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                    <li>All tasks are completed (including tasks of eliminated players)</li>
                    <li>All imposters are eliminated</li>
                </ul>

                <h4 style="color: #ff3838;">Imposters Win If:</h4>
                <ul style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8;">
                    <li>Number of imposters equals remaining crewmates (forcing tied votes)</li>
                </ul>

                <h3>Important Rules</h3>
                <ul style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8;">
                    <li><strong>Crewmates must walk.</strong> Imposters can move at any speed.</li>
                    <li><strong>Stay safe.</strong> Don't do a task if it would put you in danger. Report concerns to the host.</li>
                    <li><strong>Eliminated players can still complete tasks</strong> - your contributions still count toward crew victory!</li>
                </ul>

                <h3>Additional Rules</h3>
                <p id="additional-rules-display" style="color: #a0a0a0; margin-bottom: 20px;"></p>

                <button class="btn-primary btn-block" onclick="closeInstructions()">Got It!</button>
            </div>
        </div>

        <!-- Meeting Alert Overlay -->
        <div id="meeting-overlay" class="meeting-overlay hidden">
            <div class="meeting-content">
                <h2>MEETING CALLED</h2>
                <p style="font-size: 1.5rem; margin-bottom: 30px;">Return to: <span id="meeting-location-alert">Meeting Room</span></p>

                <button class="btn-primary" style="font-size: 1.2rem; padding: 15px 40px;" onclick="acknowledgeMeeting()">
                    I'm Here
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Modules (order matters for dependencies) -->
    <script src="js/rooms-and-tasks.js"></script>
    <script src="js/game-state.js"></script>
    <script src="js/supabase-backend.js"></script>
    <script src="js/room-task-manager.js"></script>
    <script src="js/game-logic.js"></script>
    <script src="js/init.js"></script>
</body>
</html>
